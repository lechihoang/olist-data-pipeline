bundle:
  name: olist-data-pipeline

variables:
  catalog:
    description: "Unity Catalog name"
    default: olist_project
  warehouse_id:
    description: "SQL Warehouse ID for dbt tasks"
    default: "956f28a1a104215e"
  gold_schema:
    description: "Gold layer schema name"
    default: gold

targets:
  default:
    mode: development
    default: true

resources:
  jobs:
    olist_pipeline_job: 
      name: "[Bronze-Silver-Gold] Olist Pipeline" 
      
      environments:
        - environment_key: "Default"
          spec:
            environment_version: "4"
            dependencies:
                - "dbt-core==1.8.0"
                - "dbt-databricks==1.8.0"
                - "python-dotenv"

      queue:
        enabled: true

      tasks:
        # -----------------------------------------------
        # --- run_bronze (9 TASKS) ---
        # -----------------------------------------------
        - task_key: run_bronze_orders
          description: "Nạp file 'orders' từ Volume vào bảng bronze.orders_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "orders"
              target_table_name: "orders_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_customers
          description: "Nạp file 'customers' vào bảng bronze.customers_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "customers"
              target_table_name: "customers_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_order_items
          description: "Nạp file 'order_items' vào bảng bronze.order_items_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "order_items"
              target_table_name: "order_items_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_order_payments
          description: "Nạp file 'order_payments' vào bảng bronze.order_payments_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "order_payments"
              target_table_name: "order_payments_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_products
          description: "Nạp file 'products' vào bảng bronze.products_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "products"
              target_table_name: "products_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_sellers
          description: "Nạp file 'sellers' vào bảng bronze.sellers_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "sellers"
              target_table_name: "sellers_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_geolocation
          description: "Nạp file 'geolocation' vào bảng bronze.geolocation_raw (static data)"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze_static.py
            base_parameters:
              source_dir_name: "static"
              source_file_name: "geolocation.csv"
              target_table_name: "geolocation_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_order_reviews
          description: "Nạp file 'order_reviews' vào bảng bronze.order_reviews_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "order_reviews"
              target_table_name: "order_reviews_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        - task_key: run_bronze_product_translation
          description: "Nạp file 'product_category_name_translation' (static data)"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze_static.py
            base_parameters:
              source_dir_name: "static"
              source_file_name: "product_category_name_translation.csv"
              target_table_name: "product_category_name_translation_raw"
              schema_base_path: "${workspace.file_path}/src/schemas"
          environment_key: "Default"

        # -----------------------------------------------
        # --- test_bronze (9 TESTS) ---
        # -----------------------------------------------
        - task_key: test_bronze_orders
          description: "Test data quality cho bronze.orders_raw"
          depends_on:
            - task_key: run_bronze_orders
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_orders.py
          environment_key: "Default"

        - task_key: test_bronze_customers
          description: "Test data quality cho bronze.customers_raw"
          depends_on:
            - task_key: run_bronze_customers
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_customers.py
          environment_key: "Default"

        - task_key: test_bronze_order_items
          description: "Test data quality cho bronze.order_items_raw"
          depends_on:
            - task_key: run_bronze_order_items
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_order_items.py
          environment_key: "Default"

        - task_key: test_bronze_order_payments
          description: "Test data quality cho bronze.order_payments_raw"
          depends_on:
            - task_key: run_bronze_order_payments
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_order_payments.py
          environment_key: "Default"

        - task_key: test_bronze_products
          description: "Test data quality cho bronze.products_raw"
          depends_on:
            - task_key: run_bronze_products
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_products.py
          environment_key: "Default"

        - task_key: test_bronze_sellers
          description: "Test data quality cho bronze.sellers_raw"
          depends_on:
            - task_key: run_bronze_sellers
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_sellers.py
          environment_key: "Default"

        - task_key: test_bronze_geolocation
          description: "Test data quality cho bronze.geolocation_raw"
          depends_on:
            - task_key: run_bronze_geolocation
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_geolocation.py
          environment_key: "Default"

        - task_key: test_bronze_order_reviews
          description: "Test data quality cho bronze.order_reviews_raw"
          depends_on:
            - task_key: run_bronze_order_reviews
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_order_reviews.py
          environment_key: "Default"

        - task_key: test_bronze_product_translation
          description: "Test data quality cho bronze.product_category_name_translation_raw"
          depends_on:
            - task_key: run_bronze_product_translation
          notebook_task:
            notebook_path: src/tasks/tests/bronze/test_bronze_product_translation.py
          environment_key: "Default"

        # -----------------------------------------------
        # --- run_silver (8 TASKS) ---
        # -----------------------------------------------
        - task_key: run_silver_geolocation
          description: "Dọn dẹp (Dedupe) và GHI ĐÈ bảng Geolocation"
          depends_on: 
            - task_key: test_bronze_geolocation
          notebook_task:
            notebook_path: src/tasks/silver/silver_geolocation.py
            base_parameters:
              bronze_table_input: "geolocation_raw"
              silver_table_output: "geolocation"
          environment_key: "Default"
          
        - task_key: run_silver_customers
          description: "Làm sạch, Làm giàu (JOIN Geo), và MERGE bảng Customers"
          depends_on: 
            - task_key: test_bronze_customers
            - task_key: run_silver_geolocation
          notebook_task:
            notebook_path: src/tasks/silver/silver_customers.py
            base_parameters:
              bronze_table_input: "customers_raw"
              silver_geo_table_input: "geolocation"
              silver_table_output: "customers"
          environment_key: "Default"

        - task_key: run_silver_products
          description: "Làm sạch, Dịch, và MERGE bảng Products"
          depends_on: 
            - task_key: test_bronze_products
            - task_key: test_bronze_product_translation
          notebook_task:
            notebook_path: src/tasks/silver/silver_products.py
            base_parameters:
              bronze_products_table_input: "products_raw"
              bronze_translation_table_input: "product_category_name_translation_raw"
              silver_products_table_output: "products"
          environment_key: "Default"

        - task_key: run_silver_sellers
          description: "Làm sạch và MERGE bảng Sellers"
          depends_on: 
            - task_key: test_bronze_sellers
          notebook_task:
            notebook_path: src/tasks/silver/silver_sellers.py
            base_parameters:
              bronze_table_input: "sellers_raw"
              silver_table_output: "sellers"
          environment_key: "Default"

        - task_key: run_silver_orders
          description: "Làm sạch và MERGE bảng Orders (cập nhật status)"
          depends_on: 
            - task_key: test_bronze_orders
          notebook_task:
            notebook_path: src/tasks/silver/silver_orders.py
            base_parameters:
              bronze_table_input: "orders_raw"
              silver_table_output: "orders"
          environment_key: "Default"

        - task_key: run_silver_order_items
          description: "Làm sạch và MERGE bảng Order Items"
          depends_on: 
            - task_key: test_bronze_order_items
          notebook_task:
            notebook_path: src/tasks/silver/silver_order_items.py
            base_parameters:
              bronze_table_input: "order_items_raw"
              silver_table_output: "order_items"
          environment_key: "Default"

        - task_key: run_silver_order_payments
          description: "Làm sạch và MERGE bảng Order Payments"
          depends_on: 
            - task_key: test_bronze_order_payments
          notebook_task:
            notebook_path: src/tasks/silver/silver_order_payments.py
            base_parameters:
              bronze_table_input: "order_payments_raw"
              silver_table_output: "order_payments"
          environment_key: "Default"

        - task_key: run_silver_order_reviews
          description: "Làm sạch và MERGE bảng Order Reviews"
          depends_on: 
            - task_key: test_bronze_order_reviews
          notebook_task:
            notebook_path: src/tasks/silver/silver_order_reviews.py
            base_parameters:
              bronze_table_input: "order_reviews_raw"
              silver_table_output: "order_reviews"
          environment_key: "Default"

        # -----------------------------------------------
        # --- test_silver (8 TESTS) ---
        # -----------------------------------------------
        - task_key: test_silver_geolocation
          description: "Test data quality cho silver.geolocation"
          depends_on:
            - task_key: run_silver_geolocation
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_geolocation.py
          environment_key: "Default"

        - task_key: test_silver_customers
          description: "Test data quality cho silver.customers"
          depends_on:
            - task_key: run_silver_customers
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_customers.py
          environment_key: "Default"

        - task_key: test_silver_products
          description: "Test data quality cho silver.products"
          depends_on:
            - task_key: run_silver_products
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_products.py
          environment_key: "Default"

        - task_key: test_silver_sellers
          description: "Test data quality cho silver.sellers"
          depends_on:
            - task_key: run_silver_sellers
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_sellers.py
          environment_key: "Default"

        - task_key: test_silver_orders
          description: "Test data quality cho silver.orders"
          depends_on:
            - task_key: run_silver_orders
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_orders.py
          environment_key: "Default"

        - task_key: test_silver_order_items
          description: "Test data quality cho silver.order_items"
          depends_on:
            - task_key: run_silver_order_items
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_order_items.py
          environment_key: "Default"

        - task_key: test_silver_order_payments
          description: "Test data quality cho silver.order_payments"
          depends_on:
            - task_key: run_silver_order_payments
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_order_payments.py
          environment_key: "Default"

        - task_key: test_silver_order_reviews
          description: "Test data quality cho silver.order_reviews"
          depends_on:
            - task_key: run_silver_order_reviews
          notebook_task:
            notebook_path: src/tasks/tests/silver/test_silver_order_reviews.py
          environment_key: "Default"

        # -----------------------------------------------
        # --- run_gold_dim (4 TASKS) ---
        # -----------------------------------------------
        - task_key: run_gold_dim_customers
          description: "Chạy dbt model dim_customers"
          depends_on:
            - task_key: test_silver_customers
            - task_key: test_silver_geolocation
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt deps"
              - "dbt run --select dim_customers"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: run_gold_dim_products
          description: "Chạy dbt model dim_products"
          depends_on:
            - task_key: test_silver_products
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt deps"
              - "dbt run --select dim_products"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: run_gold_dim_sellers
          description: "Chạy dbt model dim_sellers"
          depends_on:
            - task_key: test_silver_sellers
            - task_key: test_silver_geolocation
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt deps"
              - "dbt run --select dim_sellers"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: run_gold_dim_datetimes
          description: "Chạy dbt model dim_datetimes"
          depends_on:
            - task_key: test_silver_orders
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt deps"
              - "dbt run --select dim_datetimes"
            project_directory: "dbt_olist"
          environment_key: "Default"

        # -----------------------------------------------
        # --- test_gold_dim (4 TESTS) ---
        # -----------------------------------------------
        - task_key: test_gold_dim_customers
          description: "Test dbt model dim_customers"
          depends_on:
            - task_key: run_gold_dim_customers
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt test --select dim_customers"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: test_gold_dim_products
          description: "Test dbt model dim_products"
          depends_on:
            - task_key: run_gold_dim_products
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt test --select dim_products"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: test_gold_dim_sellers
          description: "Test dbt model dim_sellers"
          depends_on:
            - task_key: run_gold_dim_sellers
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt test --select dim_sellers"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: test_gold_dim_datetimes
          description: "Test dbt model dim_datetimes"
          depends_on:
            - task_key: run_gold_dim_datetimes
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt test --select dim_datetimes"
            project_directory: "dbt_olist"
          environment_key: "Default"

        # -----------------------------------------------
        # --- run_gold_fct (3 TASKS) ---
        # -----------------------------------------------
        - task_key: run_gold_fct_order_items
          description: "Chạy dbt model fct_order_items"
          depends_on:
            - task_key: test_gold_dim_customers
            - task_key: test_gold_dim_products
            - task_key: test_gold_dim_sellers
            - task_key: test_gold_dim_datetimes
            - task_key: test_silver_order_items
            - task_key: test_silver_orders
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt deps"
              - "dbt run --select fct_order_items"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: run_gold_fct_order_payments
          description: "Chạy dbt model fct_order_payments"
          depends_on:
            - task_key: test_gold_dim_customers
            - task_key: test_gold_dim_datetimes
            - task_key: test_silver_order_payments
            - task_key: test_silver_orders
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt deps"
              - "dbt run --select fct_order_payments"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: run_gold_fct_order_reviews
          description: "Chạy dbt model fct_order_reviews"
          depends_on:
            - task_key: test_gold_dim_customers
            - task_key: test_gold_dim_products
            - task_key: test_gold_dim_datetimes
            - task_key: test_silver_order_reviews
            - task_key: test_silver_orders
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt deps"
              - "dbt run --select fct_order_reviews"
            project_directory: "dbt_olist"
          environment_key: "Default"

        # -----------------------------------------------
        # --- test_gold_fct (3 TESTS) ---
        # -----------------------------------------------
        - task_key: test_gold_fct_order_items
          description: "Test dbt model fct_order_items"
          depends_on:
            - task_key: run_gold_fct_order_items
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt test --select fct_order_items"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: test_gold_fct_order_payments
          description: "Test dbt model fct_order_payments"
          depends_on:
            - task_key: run_gold_fct_order_payments
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt test --select fct_order_payments"
            project_directory: "dbt_olist"
          environment_key: "Default"

        - task_key: test_gold_fct_order_reviews
          description: "Test dbt model fct_order_reviews"
          depends_on:
            - task_key: run_gold_fct_order_reviews
          dbt_task:
            catalog: ${var.catalog}
            schema: ${var.gold_schema}
            warehouse_id: ${var.warehouse_id}
            commands:
              - "dbt test --select fct_order_reviews"
            project_directory: "dbt_olist"
          environment_key: "Default"
