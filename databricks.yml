# Tên file: databricks.yml
# --------------------
# PHIÊN BẢN SỬA LỖI:
# 1. Thêm cấu hình 'Single Node' (spark_conf, custom_tags)
# --------------------

bundle:
  name: olist-data-pipeline

targets:
  default:
    mode: development
    default: true

resources:
  jobs:
    # --- JOB [BRONZE] OLIST PIPELINE ---
    bronze_pipeline_job:
      name: "[Bronze] Olist Pipeline"
      
      tasks:
        # --- Task 1: Nạp Orders ---
        - task_key: load_bronze_orders
          description: "Nạp file 'orders' từ Volume vào bảng bronze.orders_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "orders"
              target_table_name: "orders_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            # --- SỬA CẢNH BÁO (THÊM KHỐI NÀY) ---
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        # --- Task 2: Nạp Customers ---
        - task_key: load_bronze_customers
          description: "Nạp file 'customers' vào bảng bronze.customers_raw"
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "customers"
              target_table_name: "customers_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            # --- SỬA CẢNH BÁO (THÊM KHỐI NÀY) ---
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        # --- Task 3: Nạp Order Items ---
        - task_key: load_bronze_order_items
          # ... (Lặp lại tương tự cho 7 task còn lại) ...
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "order_items"
              target_table_name: "order_items_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode
        
        # --- Task 4: Nạp Order Payments ---
        - task_key: load_bronze_order_payments
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "order_payments"
              target_table_name: "order_payments_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        # --- Task 5: Nạp Products ---
        - task_key: load_bronze_products
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "products"
              target_table_name: "products_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        # --- Task 6: Nạp Sellers ---
        - task_key: load_bronze_sellers
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "sellers"
              target_table_name: "sellers_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        # --- Task 7: Nạp Geolocation ---
        - task_key: load_bronze_geolocation
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "geolocation"
              target_table_name: "geolocation_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        # --- Task 8: Nạp Order Reviews ---
        - task_key: load_bronze_order_reviews
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "order_reviews"
              target_table_name: "order_reviews_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        # --- Task 9: Nạp Product Translation ---
        - task_key: load_bronze_product_translation
          notebook_task:
            notebook_path: src/tasks/bronze/bronze.py
            base_parameters:
              source_dir_name: "product_category_name_translation"
              target_table_name: "product_category_name_translation_raw"
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode